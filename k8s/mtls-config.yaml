apiVersion: v1
kind: Secret
metadata:
  name: helixflow-ca-cert
  namespace: helixflow-system
type: Opaque
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0t...  # Base64 encoded CA cert
---
apiVersion: v1
kind: Secret
metadata:
  name: api-gateway-tls
  namespace: helixflow-services
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0t...  # Base64 encoded service cert
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0t...  # Base64 encoded service key
---
apiVersion: v1
kind: Secret
metadata:
  name: inference-pool-tls
  namespace: helixflow-services
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0t...  # Base64 encoded service cert
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0t...  # Base64 encoded service key
---
apiVersion: v1
kind: Secret
metadata:
  name: auth-service-tls
  namespace: helixflow-services
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0t...  # Base64 encoded service cert
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0t...  # Base64 encoded service key
---
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: helixflow-services
spec:
  mtls:
    mode: STRICT
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: api-gateway-policy
  namespace: helixflow-services
spec:
  selector:
    matchLabels:
      app: api-gateway
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/helixflow-services/sa/api-gateway"]
    to:
    - operation:
        methods: ["GET", "POST"]
---
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: jwt-auth
  namespace: helixflow-services
spec:
  selector:
    matchLabels:
      app: api-gateway
  jwtRules:
  - issuer: "helixflow-auth"
    jwksUri: "https://auth-service.helixflow-services.svc.cluster.local/.well-known/jwks.json"
    forwardOriginalToken: true