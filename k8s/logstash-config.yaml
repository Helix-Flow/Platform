apiVersion: v1
kind: ConfigMap
metadata:
  name: logstash-config
  namespace: monitoring
data:
  logstash.conf: |
    input {
      http {
        port => 8080
        codec => json
      }

      beats {
        port => 5044
      }
    }

    filter {
      json {
        source => "message"
        target => "parsed"
      }

      date {
        match => ["timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"]
        target => "@timestamp"
      }

      if [parsed][service] {
        mutate {
          add_field => { "service_name" => "%{[parsed][service]}" }
        }
      }

      if [parsed][level] {
        mutate {
          lowercase => ["parsed.level"]
        }
        if [parsed][level] == "warn" {
          mutate {
            replace => { "parsed.level" => "warning" }
          }
        }
      }

      if [parsed][level] in ["error", "err", "fatal", "crit", "critical"] {
        mutate {
          add_tag => ["error"]
        }
      }

      mutate {
        gsub => [
          "message", "(?i)(password|token|key|secret|authorization)[\"\\s]*[:=][\"\\s]*[^\"\\s,&]+", "\\1: [FILTERED]",
          "parsed.email", "([a-zA-Z0-9._%+-]+)@([a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})", "[EMAIL_FILTERED]",
          "parsed.ip", "(\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})", "[IP_FILTERED]"
        ]
      }
    }

    output {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        index => "helixflow-%{+YYYY.MM.dd}"
        document_type => "_doc"
      }

      if "error" in [tags] {
        elasticsearch {
          hosts => ["elasticsearch:9200"]
          index => "helixflow-errors-%{+YYYY.MM.dd}"
          document_type => "_doc"
        }
      }

      stdout {
        codec => rubydebug
      }
    }